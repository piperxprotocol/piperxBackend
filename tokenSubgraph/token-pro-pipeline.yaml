apiVersion: 3
name: token-pro-pipeline
resource_size: m

sources:
  source_2:
    type: subgraph_entity
    subgraphs:
      - name: story-dex-swaps-mainnet
        version: 1.0.23
    name: token_price

  source_3:
    type: subgraph_entity
    subgraphs:
      - name: story-dex-swaps-mainnet
        version: 1.0.23
    name: token_swap

transforms:
  filter_token_price_by_timestamp:
    sql: SELECT * FROM source_2 WHERE `timestamp` > '2025-09-30T00:00:00Z'
    primary_key: id

  filter_token_swap_by_timestamp:
    sql: SELECT * FROM source_3 WHERE `timestamp` > '2025-09-30T00:00:00Z'
    primary_key: id

sinks:
  sink_prices:
    type: webhook
    url: https://piperxpro.piperxprotocol.workers.dev/api/launchpad/webhook/prices
    secret_name: WEBHOOK_SECRET_CM86IXFA80
    one_row_per_request: false
    from: filter_token_price_by_timestamp

  sink_swaps:
    type: webhook
    url: https://piperxpro.piperxprotocol.workers.dev/api/launchpad/webhook/swaps
    secret_name: WEBHOOK_SECRET_CM86IXFA80
    one_row_per_request: false
    from: filter_token_swap_by_timestamp

use_dedicated_ip: false
